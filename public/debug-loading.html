<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ è½½çŠ¶æ€è°ƒè¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .debug-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .debug-section h3 {
      margin-top: 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #4CAF50;
      color: white;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    .danger {
      background: #f44336;
    }
    .danger:hover {
      background: #da190b;
    }
    .info {
      background: #2196F3;
    }
    .info:hover {
      background: #0b7dda;
    }
    #console-output {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4CAF50;
    }
    .log-error {
      border-left-color: #f44336;
      background: #ffebee;
    }
    .log-warn {
      border-left-color: #ff9800;
      background: #fff3e0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” åŠ è½½çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
  
  <div class="debug-section">
    <h3>å½“å‰çŠ¶æ€</h3>
    <div id="current-status">
      <p>åŠ è½½ä¸­...</p>
    </div>
  </div>

  <div class="debug-section">
    <h3>æ§åˆ¶é¢æ¿</h3>
    <button onclick="checkLoadingState()">æ£€æŸ¥åŠ è½½çŠ¶æ€</button>
    <button onclick="forceHideLoading()" class="danger">å¼ºåˆ¶éšè—åŠ è½½</button>
    <button onclick="forceHideProgress()" class="danger">å¼ºåˆ¶éšè—è¿›åº¦æ¡</button>
    <button onclick="clearAllModals()" class="danger">æ¸…é™¤æ‰€æœ‰æ¨¡æ€æ¡†</button>
    <button onclick="refreshPage()" class="info">åˆ·æ–°é¡µé¢</button>
  </div>

  <div class="debug-section">
    <h3>æµ‹è¯•åŠŸèƒ½</h3>
    <button onclick="testShowLoading()">æµ‹è¯•æ˜¾ç¤ºåŠ è½½</button>
    <button onclick="testShowProgress()">æµ‹è¯•æ˜¾ç¤ºè¿›åº¦</button>
    <button onclick="testLoadUserTools()">æµ‹è¯•åŠ è½½ç”¨æˆ·å·¥å…·</button>
  </div>

  <div class="debug-section">
    <h3>æ§åˆ¶å°è¾“å‡º</h3>
    <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
    <div id="console-output"></div>
  </div>

  <script>
    // æ‹¦æˆªconsole.log
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLogEntry(message, type = 'log') {
      const output = document.getElementById('console-output');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      output.appendChild(entry);
      output.scrollTop = output.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addLogEntry(args.join(' '), 'log');
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addLogEntry(args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addLogEntry(args.join(' '), 'warn');
    };

    // æ£€æŸ¥åŠ è½½çŠ¶æ€
    function checkLoadingState() {
      const loadingOverlay = document.getElementById('globalLoadingOverlay');
      const progressContainer = document.getElementById('globalProgressContainer');
      const modals = document.querySelectorAll('.modal.show');
      
      const status = {
        loadingVisible: !!loadingOverlay,
        progressVisible: !!progressContainer,
        activeModals: modals.length,
        uiManagerExists: typeof window.uiManager !== 'undefined',
        appExists: typeof window.app !== 'undefined'
      };

      console.log('å½“å‰çŠ¶æ€:', JSON.stringify(status, null, 2));
      updateStatusDisplay(status);
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatusDisplay(status) {
      const statusDiv = document.getElementById('current-status');
      statusDiv.innerHTML = `
        <p><strong>åŠ è½½é®ç½©:</strong> ${status.loadingVisible ? 'âœ… æ˜¾ç¤ºä¸­' : 'âŒ å·²éšè—'}</p>
        <p><strong>è¿›åº¦æ¡:</strong> ${status.progressVisible ? 'âœ… æ˜¾ç¤ºä¸­' : 'âŒ å·²éšè—'}</p>
        <p><strong>æ´»åŠ¨æ¨¡æ€æ¡†:</strong> ${status.activeModals} ä¸ª</p>
        <p><strong>UIç®¡ç†å™¨:</strong> ${status.uiManagerExists ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</p>
        <p><strong>Appå®ä¾‹:</strong> ${status.appExists ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</p>
      `;
    }

    // å¼ºåˆ¶éšè—åŠ è½½
    function forceHideLoading() {
      const loadingOverlay = document.getElementById('globalLoadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.remove();
        console.log('âœ… å·²å¼ºåˆ¶ç§»é™¤åŠ è½½é®ç½©');
      } else {
        console.log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°åŠ è½½é®ç½©');
      }
      
      if (window.uiManager) {
        window.uiManager.hideLoading();
        console.log('âœ… å·²è°ƒç”¨ uiManager.hideLoading()');
      }
      
      checkLoadingState();
    }

    // å¼ºåˆ¶éšè—è¿›åº¦æ¡
    function forceHideProgress() {
      const progressContainer = document.getElementById('globalProgressContainer');
      if (progressContainer) {
        progressContainer.remove();
        console.log('âœ… å·²å¼ºåˆ¶ç§»é™¤è¿›åº¦æ¡');
      } else {
        console.log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°è¿›åº¦æ¡');
      }
      
      if (window.uiManager) {
        window.uiManager.hideProgress();
        console.log('âœ… å·²è°ƒç”¨ uiManager.hideProgress()');
      }
      
      checkLoadingState();
    }

    // æ¸…é™¤æ‰€æœ‰æ¨¡æ€æ¡†
    function clearAllModals() {
      const modals = document.querySelectorAll('.modal.show');
      modals.forEach(modal => {
        modal.classList.remove('show');
      });
      console.log(`âœ… å·²æ¸…é™¤ ${modals.length} ä¸ªæ¨¡æ€æ¡†`);
      checkLoadingState();
    }

    // åˆ·æ–°é¡µé¢
    function refreshPage() {
      window.location.reload();
    }

    // æ¸…ç©ºæ§åˆ¶å°
    function clearConsole() {
      document.getElementById('console-output').innerHTML = '';
    }

    // æµ‹è¯•æ˜¾ç¤ºåŠ è½½
    function testShowLoading() {
      if (window.uiManager) {
        console.log('æµ‹è¯•æ˜¾ç¤ºåŠ è½½...');
        window.uiManager.showLoading('æµ‹è¯•åŠ è½½ä¸­...', 'dots');
        setTimeout(() => {
          window.uiManager.hideLoading();
          console.log('æµ‹è¯•å®Œæˆï¼Œå·²éšè—åŠ è½½');
        }, 2000);
      } else {
        console.error('UIç®¡ç†å™¨æœªåŠ è½½');
      }
    }

    // æµ‹è¯•æ˜¾ç¤ºè¿›åº¦
    function testShowProgress() {
      if (window.uiManager) {
        console.log('æµ‹è¯•æ˜¾ç¤ºè¿›åº¦...');
        window.uiManager.showProgress(0, 'æµ‹è¯•è¿›åº¦...');
        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          window.uiManager.updateProgress(progress, `è¿›åº¦ ${progress}%`);
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              window.uiManager.hideProgress();
              console.log('æµ‹è¯•å®Œæˆï¼Œå·²éšè—è¿›åº¦');
            }, 500);
          }
        }, 200);
      } else {
        console.error('UIç®¡ç†å™¨æœªåŠ è½½');
      }
    }

    // æµ‹è¯•åŠ è½½ç”¨æˆ·å·¥å…·
    async function testLoadUserTools() {
      if (window.app) {
        console.log('æµ‹è¯•åŠ è½½ç”¨æˆ·å·¥å…·...');
        try {
          await window.app.loadUserCustomTools();
          console.log('âœ… åŠ è½½å®Œæˆ');
        } catch (error) {
          console.error('âŒ åŠ è½½å¤±è´¥:', error);
        }
      } else {
        console.error('Appå®ä¾‹æœªåŠ è½½');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
    window.addEventListener('load', () => {
      console.log('è°ƒè¯•é¡µé¢å·²åŠ è½½');
      setTimeout(checkLoadingState, 1000);
    });

    // å®šæœŸæ£€æŸ¥çŠ¶æ€
    setInterval(checkLoadingState, 5000);
  </script>
</body>
</html>
