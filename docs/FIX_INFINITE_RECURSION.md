# ğŸ”§ ä¿®å¤æ— é™é€’å½’é”™è¯¯

## é—®é¢˜æè¿°

æ§åˆ¶å°æŠ¥é”™ï¼š`infinite recursion detected in policy for relation "admin_users"`

è¿™æ˜¯ç”±äº `admin_users` è¡¨çš„ RLS ç­–ç•¥é€ æˆäº†å¾ªç¯å¼•ç”¨ã€‚

## é—®é¢˜åŸå› 

åŸå§‹ç­–ç•¥ï¼š
```sql
CREATE POLICY "Admin users can view admin list"
  ON admin_users FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM admin_users au   -- âŒ è¿™é‡ŒæŸ¥è¯¢ admin_users
      WHERE au.user_id = auth.uid()  -- åˆè§¦å‘äº†åŒä¸€ä¸ªç­–ç•¥ï¼Œé€ æˆæ— é™é€’å½’
    )
  );
```

å½“ç³»ç»Ÿæ£€æŸ¥æƒé™æ—¶ï¼š
1. ç”¨æˆ·å°è¯•æŸ¥è¯¢ `admin_users` è¡¨
2. è§¦å‘ RLS ç­–ç•¥æ£€æŸ¥
3. ç­–ç•¥ä¸­åˆæŸ¥è¯¢ `admin_users` è¡¨
4. å†æ¬¡è§¦å‘ RLS ç­–ç•¥æ£€æŸ¥
5. æ— é™å¾ªç¯...

## å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ–¹æ³• 1ï¼šä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰

1. **æ‰“å¼€ Supabase Dashboard**
   - è®¿é—®ï¼šhttps://supabase.com/dashboard
   - é€‰æ‹©ä½ çš„é¡¹ç›®

2. **æ‰“å¼€ SQL Editor**
   - å·¦ä¾§èœå• -> SQL Editor
   - ç‚¹å‡» "New query"

3. **è¿è¡Œä¿®å¤è„šæœ¬**
   - å¤åˆ¶ `config/fix-infinite-recursion.sql` çš„å†…å®¹
   - ç²˜è´´åˆ° SQL Editor
   - ç‚¹å‡» "Run" æ‰§è¡Œ

4. **åˆ·æ–°ç½‘ç«™**
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+R æˆ– Cmd+Shift+Rï¼‰
   - é‡æ–°åŠ è½½é¡µé¢

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨ä¿®å¤

åœ¨ Supabase SQL Editor ä¸­ä¾æ¬¡æ‰§è¡Œï¼š

```sql
-- 1. åˆ é™¤æœ‰é—®é¢˜çš„ç­–ç•¥
DROP POLICY IF EXISTS "Admin users can view admin list" ON admin_users;

-- 2. åˆ›å»ºä¿®å¤åçš„ç­–ç•¥
CREATE POLICY "Authenticated users can view admin list"
  ON admin_users FOR SELECT
  USING (auth.role() = 'authenticated');
```

## éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

1. **æ§åˆ¶å°æ— é”™è¯¯**
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
   - åˆ·æ–°é¡µé¢
   - ç¡®è®¤æ²¡æœ‰ "infinite recursion" é”™è¯¯

2. **åŠŸèƒ½æ­£å¸¸**
   - ç™»å½•åŠŸèƒ½æ­£å¸¸
   - å¯ä»¥æŸ¥çœ‹å·¥å…·åˆ—è¡¨
   - å¯ä»¥æ·»åŠ /ç¼–è¾‘/åˆ é™¤å·¥å…·

## ä¿®å¤è¯´æ˜

### åŸç­–ç•¥çš„é—®é¢˜
```sql
-- âŒ é”™è¯¯ï¼šé€ æˆæ— é™é€’å½’
USING (
  EXISTS (
    SELECT 1 FROM admin_users au 
    WHERE au.user_id = auth.uid()
  )
)
```

### ä¿®å¤åçš„ç­–ç•¥
```sql
-- âœ… æ­£ç¡®ï¼šä½¿ç”¨ auth.role() é¿å…é€’å½’
USING (auth.role() = 'authenticated')
```

### ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤ï¼Ÿ

1. **auth.role()** æ˜¯ Supabase å†…ç½®å‡½æ•°ï¼Œä¸ä¼šè§¦å‘ RLS ç­–ç•¥
2. **'authenticated'** è¡¨ç¤ºæ‰€æœ‰å·²ç™»å½•ç”¨æˆ·
3. è¿™æ ·æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥æŸ¥çœ‹ç®¡ç†å‘˜åˆ—è¡¨ï¼ˆç”¨äºæ£€æŸ¥è‡ªå·±æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼‰

### å®‰å…¨æ€§è€ƒè™‘

å…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·æŸ¥çœ‹ç®¡ç†å‘˜åˆ—è¡¨æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºï¼š
- åªæš´éœ²äº†å“ªäº›ç”¨æˆ·æ˜¯ç®¡ç†å‘˜
- ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€é‚®ç®±ç­‰ï¼‰
- ç®¡ç†å‘˜æ“ä½œä»ç„¶å—åˆ°å…¶ä»–ç­–ç•¥ä¿æŠ¤

å¦‚æœéœ€è¦æ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥è€ƒè™‘ï¼š
```sql
-- é€‰é¡¹ï¼šåªå…è®¸ç®¡ç†å‘˜æŸ¥çœ‹ç®¡ç†å‘˜åˆ—è¡¨
-- ä½†éœ€è¦ä½¿ç”¨å‡½æ•°æ¥é¿å…é€’å½’
CREATE POLICY "Only admins can view admin list"
  ON admin_users FOR SELECT
  USING (is_admin(auth.uid()));
```

## å®Œæ•´é‡å»ºï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨å®Œæ•´çš„ä¿®å¤è„šæœ¬ï¼š

1. ä½¿ç”¨ `config/admin-permissions-setup-fixed.sql`
2. è¿™ä¸ªè„šæœ¬ä¼šï¼š
   - åˆ é™¤æ‰€æœ‰æ—§ç­–ç•¥
   - é‡æ–°åˆ›å»ºæ­£ç¡®çš„ç­–ç•¥
   - ä¿®å¤å‡½æ•°å®šä¹‰

## åç»­æ­¥éª¤

ä¿®å¤å®Œæˆåï¼š

1. âœ… æµ‹è¯•åŸºæœ¬åŠŸèƒ½
2. âœ… æ·»åŠ ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·
3. âœ… æµ‹è¯•ç®¡ç†å‘˜åŠŸèƒ½
4. âœ… ç»§ç»­å¼€å‘ç®¡ç†å‘˜é¢æ¿

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼š
1. æ£€æŸ¥ Supabase Dashboard -> Database -> Policies
2. ç¡®è®¤æ‰€æœ‰ç­–ç•¥éƒ½å·²æ­£ç¡®åˆ›å»º
3. æŸ¥çœ‹ Supabase Logs è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
